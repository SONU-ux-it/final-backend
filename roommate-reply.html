<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Roommate Replies</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #fffbdc; }
    .post { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; background: white; border-radius: 10px; }
    .post h3 { margin: 0; }
    .reply-box { margin-top: 10px; }
    textarea { width: 100%; padding: 8px; border-radius: 5px; margin-top: 5px; }
    button { margin-top: 5px; padding: 8px 12px; background: green; color: white; border: none; border-radius: 5px; }
    .replies { background: #f0f0f0; padding: 10px; border-radius: 8px; margin-top: 10px; }
    .replies h4 { margin: 0 0 10px 0; }
    .delete-btn {
      background: red; margin-top: 5px; padding: 6px 10px; color: white;
      border: none; border-radius: 4px; float: right;
    }
  </style>
</head>
<body>
  <h2>Roommate Posts & Replies</h2>
  <div id="postList"></div>

  <script>
    // Get user info or ask
    const userName = localStorage.getItem("userName") || prompt("Enter your name:");
    const userEmail = localStorage.getItem("userEmail") || prompt("Enter your email:");
    const userGender = localStorage.getItem("userGender") || prompt("Enter your gender (Male/Female):");

    localStorage.setItem("userName", userName);
    localStorage.setItem("userEmail", userEmail);
    localStorage.setItem("userGender", userGender);

    async function loadPosts() {
      const res = await fetch("http://localhost:3000/posts");
      const data = await res.json();
      const container = document.getElementById("postList");
      container.innerHTML = "";

      data.forEach(post => {
        const div = document.createElement("div");
        div.className = "post";

        // replies
        let repliesHtml = "";
        if (post.replies && post.replies.length > 0) {
          repliesHtml = `<div class="replies"><h4>Replies:</h4>` +
            post.replies.map(r =>
              `<div class="reply-msg"><b>${r.fromName} (${r.fromGender})</b>: ${r.text}</div>`
            ).join("") +
            `</div>`;
        }

        // Delete button only if current user is post owner
        const deleteBtn = (post.email === userEmail)
          ? `<button class="delete-btn" onclick="deletePost('${post.id}')">Delete Post</button>`
          : "";

        div.innerHTML = `
          ${deleteBtn}
          <h3>${post.name} (${post.gender})</h3>
          <p>${post.message}</p>
          ${repliesHtml}
          <div class="reply-box">
            <textarea id="reply-${post.id}" rows="3" placeholder="Write your reply..."></textarea><br>
            <button onclick="sendReply('${post.id}', this)">Send Reply</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function sendReply(postId, btn) {
      const textarea = document.getElementById(`reply-${postId}`);
      const replyText = textarea.value.trim();
      if (!replyText) return alert("Reply cannot be empty");

      const body = {
        postId,
        fromName: userName,
        fromGender: userGender,
        message: replyText
      };

      const res = await fetch("http://localhost:3000/reply-roommate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const json = await res.json();
      if (json.success) {
        textarea.value = "";
        loadPosts(); // refresh
      } else {
        alert("Failed to send reply");
      }
    }

    async function deletePost(postId) {
      if (!confirm("Are you sure you want to delete this post?")) return;

      const res = await fetch(`http://localhost:3000/delete/${postId}`);
      const text = await res.text();
      alert(text);
      loadPosts();
    }

    loadPosts();
  </script>
</body>
</html>
